[
    {
        "id": "691e4b827a8bbdd4",
        "type": "function",
        "z": "8643b3f6744861e3",
        "name": "Generate Message",
        "func": "// 1. Láº¥y Intent an toÃ n (TrÃ¡nh lá»—i undefined cho Dispatcher)\nvar intent = (msg.payload && msg.payload.intent) ? msg.payload.intent : \"None\";\n\n// 2. Láº¥y dá»¯ liá»‡u cáº£m biáº¿n (cho cÃ¡c cÃ¢u há»i thÃ´ng sá»‘)\nvar temp = flow.get(\"temperature\") || 0;\nvar hum  = flow.get(\"humidity\") || 0;\nvar vel  = flow.get(\"velocity\") || 0;\nvar dist = flow.get(\"distance\") || 0;\nvar light = flow.get(\"brightness\") || 0;\nvar viol = flow.get(\"violationHistory\") || [];\n\nvar responseText = \"\";\n\n// 3. LOGIC TRáº¢ Lá»œI\n\n// --- NhÃ³m ThÃ´ng sá»‘ Cáº£m biáº¿n ---\nif (intent === \"ask_temp\") {\n    responseText = `Nhiá»‡t Ä‘á»™ hiá»‡n táº¡i lÃ  ${temp}Â°C.`;\n    if(temp > 40) responseText += \" (KhÃ¡ nÃ³ng, hÃ£y cáº©n tháº­n!)\";\n}\nelse if (intent === \"ask_humidity\") {\n    responseText = `Äá»™ áº©m mÃ´i trÆ°á»ng lÃ  ${hum}%.`;\n}\nelse if (intent === \"ask_velocity\") {\n    responseText = `Xe Ä‘ang cháº¡y vá»›i tá»‘c Ä‘á»™ ${vel} km/h.`;\n    if(vel > 60) responseText += \" (Báº¡n Ä‘ang cháº¡y quÃ¡ tá»‘c Ä‘á»™!)\";\n}\nelse if (intent === \"ask_distance\") {\n    responseText = `Khoáº£ng cÃ¡ch Ä‘áº¿n váº­t cáº£n trÆ°á»›c máº·t: ${dist} cm.`;\n}\nelse if (intent === \"ask_brightness\") {\n    var status = (light < 1200) ? \"Trá»i tá»‘i (ÄÃ¨n tá»± báº­t)\" : \"Trá»i sÃ¡ng (ÄÃ¨n táº¯t)\";\n    responseText = `CÆ°á»ng Ä‘á»™ sÃ¡ng: ${light} lux. -> ${status}.`;\n}\nelse if (intent === \"ask_violation\") {\n    if(viol.length === 0) responseText = \"Tuyá»‡t vá»i! Báº¡n chÆ°a cÃ³ lá»—i vi pháº¡m nÃ o.\";\n    else responseText = `Há»‡ thá»‘ng ghi nháº­n báº¡n Ä‘Ã£ cÃ³ ${viol.length} láº§n vi pháº¡m an toÃ n.`;\n}\nelse if (intent === \"ask_all_system\") {\n    responseText = `ğŸ“Š BÃ¡o cÃ¡o: Nhiá»‡t Ä‘á»™ ${temp}Â°C | Äá»™ áº©m ${hum}% | Tá»‘c Ä‘á»™ ${vel}km/h | Váº­t cáº£n ${dist}cm.`;\n}\n\n// --- NhÃ³m Giáº£i thÃ­ch Chá»©c nÄƒng App (Má»šI) ---\nelse if (intent === \"explain_lock\") {\n    responseText = \"ğŸ”’ Chá»©c nÄƒng **Lock Request**: DÃ¹ng Ä‘á»ƒ ngáº¯t Relay, táº¯t mÃ¡y xe tá»« xa nháº±m chá»‘ng trá»™m hoáº·c khi khÃ´ng sá»­ dá»¥ng.\";\n}\nelse if (intent === \"explain_unlock\") {\n    responseText = \"ğŸ”“ Chá»©c nÄƒng **Unlock**: DÃ¹ng Ä‘á»ƒ Ä‘Ã³ng Relay, má»Ÿ khÃ³a Ä‘iá»‡n cho phÃ©p xe hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng trá»Ÿ láº¡i.\";\n}\nelse if (intent === \"explain_buzzer\") {\n    responseText = \"ğŸ”Š Chá»©c nÄƒng **Notify Buzzer**: KÃ­ch hoáº¡t cÃ²i chÃ­p trÃªn xe kÃªu 'bÃ­p bÃ­p'. DÃ¹ng Ä‘á»ƒ tÃ¬m xe trong bÃ£i hoáº·c cáº£nh bÃ¡o ngÆ°á»i xung quanh.\";\n}\nelse if (intent === \"explain_phone\") {\n    responseText = \"ğŸ“± Chá»©c nÄƒng **Notify Phone**: Gá»­i thÃ´ng bÃ¡o Ä‘áº©y (Push Notification) vá» Ä‘iá»‡n thoáº¡i cá»§a chá»§ xe thÃ´ng qua á»©ng dá»¥ng Pushsafer.\";\n}\nelse if (intent === \"explain_email\") {\n    responseText = \"ğŸ“§ Chá»©c nÄƒng **Notify Email**: Gá»­i má»™t email cáº£nh bÃ¡o chi tiáº¿t (thá»i gian, Ä‘á»‹a Ä‘iá»ƒm, lá»—i) Ä‘áº¿n há»™p thÆ° cá»§a chá»§ xe.\";\n}\nelse if (intent === \"explain_clear\") {\n    responseText = \"ğŸ—‘ï¸ Chá»©c nÄƒng **Clear Violation**: XÃ³a toÃ n bá»™ lá»‹ch sá»­ vi pháº¡m Ä‘Ã£ lÆ°u táº¡m thá»i trÃªn há»‡ thá»‘ng (Reset bá»™ Ä‘áº¿m vá» 0).\";\n}\n\n// --- NhÃ³m XÃ£ giao ---\nelse if (intent === \"greeting\") responseText = \"Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ áº£o IoT. Báº¡n cáº§n kiá»ƒm tra thÃ´ng sá»‘ hay há»i vá» chá»©c nÄƒng nÃ o?\";\nelse if (intent === \"thanks\") responseText = \"KhÃ´ng cÃ³ chi! Ráº¥t vui Ä‘Æ°á»£c há»— trá»£ báº¡n.\";\nelse if (intent === \"goodbye\") responseText = \"Táº¡m biá»‡t! LÃ¡i xe an toÃ n nhÃ©.\";\n\n// --- Fallback ---\nelse {\n    responseText = \"Xin lá»—i, tÃ´i chÆ°a hiá»ƒu rÃµ. Báº¡n cÃ³ thá»ƒ há»i 'Nhiá»‡t Ä‘á»™', 'Lock Ä‘á»ƒ lÃ m gÃ¬' hoáº·c 'BÃ¡o cÃ¡o há»‡ thá»‘ng'.\";\n}\n\n// 4. QUAN TRá»ŒNG: ÄÃ³ng gÃ³i láº¡i payload Ä‘á»ƒ Dispatcher hoáº¡t Ä‘á»™ng\nmsg.payload.payload = responseText;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 1380,
        "wires": [
            [
                "6d2a750f8fb61d3e"
            ]
        ]
    }
]